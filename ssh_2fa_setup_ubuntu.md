
# Secure SSH Access with Public Key + TOTP 2FA on Ubuntu

This guide helps you configure SSH to require **both** an SSH key and a time-based one-time password (TOTP) using **Google Authenticator** or compatible apps like **Aegis** or **FreeOTP**.

---

## Step 1: Install Google Authenticator PAM Module

```bash
sudo apt update
sudo apt install libpam-google-authenticator
```

---

## Step 2: Configure TOTP for Your User

Run the setup command as the user who will connect via SSH:

```bash
google-authenticator
```

Answer the prompts:

- **Time-based tokens?** → `yes`
- **Update `.google_authenticator` file?** → `yes`
- **Disallow multiple uses?** → `yes`
- **Enable rate-limiting?** → `yes`
- **Emergency codes:** Save these securely!

You will receive:

- A **QR code** to scan with your authenticator app (Google Authenticator, Aegis, FreeOTP)
- A **secret key**
- **Emergency backup codes**

---

## Step 3: Configure PAM for SSH to Require TOTP

Edit the SSH PAM config:

```bash
sudo nano /etc/pam.d/sshd
```

Modify or add **at the top**:

```text
auth required pam_google_authenticator.so
```

**Important:** Comment out to remove password authentication:

```text
@include common-auth
```

to avoid prompting for system password.

---

## Step 4: Update SSH Server Configuration

Edit the SSH daemon config file:

```bash
sudo nano /etc/ssh/sshd_config
```

Ensure these lines are set:

```ini
# Require both public key and TOTP
AuthenticationMethods publickey,keyboard-interactive

# Disable password authentication alone
PasswordAuthentication no

# Enable PAM and challenge-response for 2FA
UsePAM yes
ChallengeResponseAuthentication yes
KbdInteractiveAuthentication yes
```

---

## Step 5: Restart SSH Service

After all changes:

```bash
sudo systemctl restart ssh
```

---

## Step 6: Testing Your Setup

- **Open a new terminal session** to avoid lockout.
- Connect via SSH:

```bash
ssh user@your-server
```

- You should be prompted to authenticate with your **SSH private key**.
- Next, you will be asked for the **verification code** from your authenticator app.
- No system password prompt should appear.

---

## Summary

| Step                     | Command / Configuration                                      |
|--------------------------|--------------------------------------------------------------|
| Install PAM module       | `sudo apt install libpam-google-authenticator`               |
| Initialize TOTP          | `google-authenticator`                                        |
| Configure PAM for SSH    | `auth required pam_google_authenticator.so` in `/etc/pam.d/sshd` |
| Update SSH config        | Set `AuthenticationMethods publickey,keyboard-interactive` and disable password auth |
| Restart SSH              | `sudo systemctl restart ssh`                                 |
| Test SSH login           | `ssh user@your-server`                                       |

---

## Notes

- Backup emergency codes generated by `google-authenticator` safely.
- Always keep a working SSH session open when testing new configs.
- For multiple users, repeat Step 2 for each user who needs 2FA.
- Use apps like **Google Authenticator**, **Aegis**, or **FreeOTP** for scanning QR codes.

---

If you want, I can help you generate a script to automate these steps!
